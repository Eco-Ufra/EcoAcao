<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard â€“ EcoAÃ§Ã£o</title>
    <style>
        :root { --p: #1b5e20; --s: #43a047; --bg: #f4f7f6; }
        
        /* Reset bÃ¡sico e Box-Sizing para evitar quebras de layout */
        * { box-sizing: border-box; }

        /* ComeÃ§a invisÃ­vel para evitar erro visual no carregamento */
        body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); visibility: hidden; }
        
        /* HEADER RESPONSIVO */
        .header { 
            background: var(--p); 
            color: white; 
            padding: 15px 5%; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            flex-wrap: wrap; 
            gap: 15px;
        }
        .logo { font-weight: bold; font-size: 1.2rem; white-space: nowrap; }
        
        .nav-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .nav-btns button { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            padding: 8px 16px; 
            border-radius: 20px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .nav-btns button:hover { background: rgba(255,255,255,0.3); }
        .btn-sair { background: #c62828 !important; }
        .btn-sair:hover { background: #b71c1c !important; }

        .main { max-width: 900px; margin: 30px auto; padding: 0 20px; }

        /* CARD DE PERFIL */
        .profile-box { 
            background: white; border-radius: 20px; display: flex; overflow: hidden; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; 
        }
        .user-info { padding: 35px; flex: 1; background: linear-gradient(135deg, var(--p), var(--s)); color: white; }
        .user-info h2 { margin: 0; font-size: 1.8rem; word-wrap: break-word; }
        .user-info p { margin: 8px 0 0; opacity: 0.9; }

        .user-score { 
            padding: 35px; width: 180px; background: white; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        .score-num { font-size: 3.2rem; font-weight: 900; color: var(--p); line-height: 1; }
        .score-label { font-size: 0.75rem; color: #888; font-weight: bold; margin-top: 5px; letter-spacing: 1px; }

        /* GRID DE AÃ‡Ã•ES */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        
        .card-acao { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; display: flex; flex-direction: column; }
        .status-tag { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 4px 10px; border-radius: 5px; margin-bottom: 10px; align-self: flex-start; }
        
        .pendente { background: #fff8e1; color: #b7791f; }
        .aprovada { background: #e8f5e9; color: #2e7d32; }
        .rejeitada { background: #ffebee; color: #c62828; }

        .img-acao { width: 100%; height: 160px; object-fit: cover; border-radius: 10px; margin-top: 10px; background: #eee; }

        /* AJUSTES MOBILE */
        @media (max-width: 600px) {
            .header { justify-content: center; flex-direction: column; padding: 15px; }
            .nav-btns { width: 100%; justify-content: center; }
            .nav-btns button { flex: 1; text-align: center; max-width: 120px; font-size: 0.8rem; padding: 10px 5px; }

            .main { padding: 0 15px; margin-top: 20px; }

            .profile-box { flex-direction: column; }
            .user-info { padding: 25px; text-align: center; }
            .user-score { width: 100%; padding: 20px; border-top: 1px solid #eee; flex-direction: row; justify-content: center; gap: 15px; }
            
            .score-num { font-size: 2.5rem; }
            .score-label { margin-top: 0; align-self: center; text-align: left; }
        }
    </style>
</head>
<body id="dashboardBody">

    <header class="header">
        <div class="logo">ðŸŒ± EcoAÃ§Ã£o</div>
        <div class="nav-btns">
            <button onclick="location.href='acoes.html'">+ Nova</button>
            <button onclick="location.href='ranking.html'">Ranking</button>
            <button class="btn-sair" onclick="fazerLogout()">Sair</button>
        </div>
    </header>

    <main class="main">
        <div class="profile-box">
            <div class="user-info">
                <h2 id="exibirNome">Carregando...</h2>
                <p id="exibirCurso">---</p>
                <p id="exibirEmail" style="font-size: 0.8rem; opacity: 0.7; margin-top: 15px;">---</p>
            </div>
            <div class="user-score">
                <div class="score-num" id="exibirPontos">0</div>
                <div class="score-label">PONTOS<br>ACUMULADOS</div>
            </div>
        </div>

        <h3 style="color:#333; margin-bottom: 20px;">ðŸ“‹ Meu HistÃ³rico</h3>
        <div id="containerAcoes" class="grid">
            </div>
    </main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAgKsk6jSIQk7AQ35xmVpnSn84pU8ca0g8",
        authDomain: "ecoacao-eda80.firebaseapp.com",
        projectId: "ecoacao-eda80"
    };

    // Inicializar Firebase com tratamento de erro
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "login.html";
            return;
        }

        try {
            const userRef = doc(db, "usuarios", user.uid);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                const dados = userSnap.data();

                // 1. SEGURANÃ‡A: Se for admin, nÃ£o entra aqui
                if (dados.admin === true) {
                    window.location.replace("admin.html");
                    return;
                }

                // 2. MOSTRAR TELA
                document.getElementById("dashboardBody").style.visibility = "visible";

                // 3. PREENCHER DADOS
                document.getElementById("exibirNome").innerText = dados.nome || "UsuÃ¡rio";
                document.getElementById("exibirCurso").innerText = "Curso: " + (dados.curso || "NÃ£o informado");
                document.getElementById("exibirEmail").innerText = user.email;
                document.getElementById("exibirPontos").innerText = dados.pontos || 0;

                // 4. CARREGAR AÃ‡Ã•ES EM TEMPO REAL
                const q = query(collection(db, "acoes_pendentes"), where("uid", "==", user.uid));
                onSnapshot(q, (snapshot) => {
                    const container = document.getElementById("containerAcoes");
                    container.innerHTML = "";
                    
                    if (snapshot.empty) {
                        container.innerHTML = "<p style='color:#666'>VocÃª ainda nÃ£o enviou aÃ§Ãµes.</p>";
                        return;
                    }

                    snapshot.forEach(docAcao => {
                        const acao = docAcao.data();
                        const card = document.createElement("div");
                        card.className = "card-acao";
                        
                        const statusClass = acao.status === 'aprovada' ? 'aprovada' : (acao.status === 'rejeitada' ? 'rejeitada' : 'pendente');
                        
                        card.innerHTML = `
                            <span class="status-tag ${statusClass}">${acao.status || 'pendente'}</span>
                            <div style="font-weight:bold; color:#333">${acao.acao}</div>
                            <div style="font-size:0.85rem; color:#666">Valor: ${acao.pontos} pontos</div>
                            ${acao.comprovanteBase64 ? `<img src="${acao.comprovanteBase64}" class="img-acao">` : ''}
                            ${acao.motivoRejeicao ? `<p style="color:red; font-size:0.75rem; margin-top:10px"><b>Motivo:</b> ${acao.motivoRejeicao}</p>` : ''}
                        `;
                        container.appendChild(card);
                    });
                });

            } else {
                alert("Erro: Cadastro nÃ£o encontrado no banco de dados.");
                await signOut(auth);
                window.location.href = "login.html";
            }
        } catch (error) {
            console.error("Erro no Dashboard:", error);
        }
    });

    window.fazerLogout = () => {
        signOut(auth).then(() => { window.location.href = "login.html"; });
    };
</script>
</body>
</html>

