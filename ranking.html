<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ranking ‚Äì EcoA√ß√£o Acad√™mica</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#f4f8f6;
}
header{
  background:#2e7d32;
  color:#fff;
  padding:20px;
}
header h1{margin:0}
nav{
  margin-top:10px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
nav button{
  background:#1b5e20;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:10px;
  cursor:pointer;
}

main{
  max-width:900px;
  margin:20px auto;
  background:#fff;
  padding:20px;
  border-radius:18px;
}

.toggle{
  display:flex;
  gap:10px;
  margin-bottom:16px;
}
.toggle button{
  background:#e0e0e0;
  color:#333;
  border:none;
  padding:8px 14px;
  border-radius:10px;
  cursor:pointer;
  font-weight:bold;
}
.toggle button.ativo{
  background:#2e7d32;
  color:#fff;
}

table{
  width:100%;
  border-collapse:collapse;
}
th, td{
  padding:12px;
  text-align:left;
}
th{
  background:#e8f5e9;
}
tr:nth-child(even){
  background:#f9f9f9;
}
.rank{
  font-weight:bold;
  color:#2e7d32;
}
</style>
</head>

<body>

<header>
  <h1>üèÜ Ranking EcoA√ß√£o</h1>
  <nav>
    <button onclick="ir('dashboard.html')">Dashboard</button>
    <button onclick="ir('acoes.html')">A√ß√µes</button>
    <button onclick="logout()">Sair</button>
  </nav>
</header>

<main>

<div class="toggle">
  <button id="btnGeral" class="ativo" onclick="mostrarGeral()">Ranking Geral</button>
  <button id="btnMensal" onclick="mostrarMensal()">Ranking Mensal</button>
</div>

<table>
  <thead>
    <tr>
      <th>#</th>
      <th>Nome</th>
      <th>Curso</th>
      <th>Pontos</th>
    </tr>
  </thead>
  <tbody id="ranking"></tbody>
</table>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  orderBy,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* üî• Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAgKsk6jSIQk7AQ35xmVpnSn84pU8ca0g8",
  authDomain: "ecoacao-eda80.firebaseapp.com",
  projectId: "ecoacao-eda80",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const tabela = document.getElementById("ranking");
const btnGeral = document.getElementById("btnGeral");
const btnMensal = document.getElementById("btnMensal");

let unsubscribe = null;

/* üîí Prote√ß√£o */
onAuthStateChanged(auth, (user)=>{
  if(!user){
    window.location.href = "login.html";
    return;
  }
  carregarRankingGeral();
});

/* üèÜ Ranking Geral */
function carregarRankingGeral(){
  if(unsubscribe) unsubscribe();

  btnGeral.classList.add("ativo");
  btnMensal.classList.remove("ativo");

  const q = query(
    collection(db, "usuarios"),
    orderBy("pontos", "desc")
  );

  unsubscribe = onSnapshot(q, snap=>{
    renderTabela(snap);
  });
}

/* üìÖ Ranking Mensal */
function carregarRankingMensal(){
  if(unsubscribe) unsubscribe();

  btnMensal.classList.add("ativo");
  btnGeral.classList.remove("ativo");

  const mes = new Date().toISOString().slice(0,7); // ex: 2026-01

  const q = query(
    collection(db, "ranking_mensal", mes, "usuarios"),
    orderBy("pontos", "desc")
  );

  unsubscribe = onSnapshot(q, snap=>{
    renderTabela(snap);
  });
}

/* üéñÔ∏è Renderiza√ß√£o com medalhas */
function renderTabela(snap){
  tabela.innerHTML = "";
  let posicao = 1;

  snap.forEach(doc=>{
    const u = doc.data();
    if(u.admin === true) return;

    let medalha = "";
    if(posicao === 1) medalha = "ü•á";
    if(posicao === 2) medalha = "ü•à";
    if(posicao === 3) medalha = "ü•â";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="rank">${medalha} ${posicao}¬∫</td>
      <td>${u.nome}</td>
      <td>${u.curso || "-"}</td>
      <td>${u.pontos || 0}</td>
    `;
    tabela.appendChild(tr);
    posicao++;
  });

  if(posicao === 1){
    tabela.innerHTML = "<tr><td colspan='4'>Nenhum dado dispon√≠vel</td></tr>";
  }
}

/* üîÄ Bot√µes */
window.mostrarGeral = carregarRankingGeral;
window.mostrarMensal = carregarRankingMensal;

/* üö™ Logout */
window.logout = async ()=>{
  await signOut(auth);
  window.location.href = "login.html";
};

window.ir = p => window.location.href = p;
</script>
</body>
</html>
