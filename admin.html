<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Admin ‚Äì EcoA√ß√£o Acad√™mica</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    :root { --verde-dark: #1b5e20; --verde-primary: #2e7d32; --verde-light: #43a047; --vermelho: #d32f2f; --bg: #f0f2f5; --shadow: 0 4px 12px rgba(0,0,0,0.1); }
    body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); margin: 0; color: #333; padding-bottom: 50px; }
    header { background: linear-gradient(135deg, var(--verde-dark), var(--verde-primary)); color: #fff; padding: 20px; text-align: center; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; }
    .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }
    h2 { color: var(--verde-dark); border-bottom: 2px solid #ddd; padding-bottom: 10px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: var(--shadow); display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.2s; }
    .card:hover { transform: translateY(-3px); }
    .user-info { font-size: 0.9rem; color: #666; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    .acao-title { font-size: 1.2rem; font-weight: bold; color: var(--verde-primary); margin: 5px 0; }
    .pontos-badge { background: #e8f5e9; color: var(--verde-dark); padding: 4px 10px; border-radius: 15px; font-weight: bold; font-size: 0.9rem; display: inline-block; margin-bottom: 10px; }
    .comprovante-img { width: 100%; height: 200px; object-fit: contain; background: #000; border-radius: 8px; margin: 10px 0; cursor: pointer; }
    .actions { display: flex; gap: 10px; margin-top: 15px; }
    button { flex: 1; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; }
    .btn-aprovar { background: var(--verde-light); color: white; }
    .btn-aprovar:hover { background: var(--verde-dark); }
    .btn-rejeitar { background: #ffebee; color: var(--vermelho); border: 1px solid var(--vermelho); }
    .btn-rejeitar:hover { background: var(--vermelho); color: white; }
    .empty-state { text-align: center; color: #777; margin-top: 50px; font-size: 1.2rem; }
</style>
</head>
<body>

<header>
    <h1>üõ°Ô∏è Painel Admin</h1>
    <nav>
        <button onclick="logout()" style="background:rgba(255,255,255,0.2); width:auto; padding: 5px 15px; font-size: 0.9rem; color: white;">Sair</button>
    </nav>
</header>

<div class="container">
    <h2>A√ß√µes Pendentes de Aprova√ß√£o</h2>
    <div id="listaPendentes" class="grid">
        <p style="text-align:center; width:100%">Carregando solicita√ß√µes...</p>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, collection, query, where, onSnapshot, updateDoc, doc, increment, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* üî• SUA CONFIGURA√á√ÉO ORIGINAL RECUPERADA üî• */
const firebaseConfig = {
  apiKey: "AIzaSyAgKsk6jSIQk7AQ35xmVpnSn84pU8ca0g8",
  authDomain: "ecoacao-eda80.firebaseapp.com",
  projectId: "ecoacao-eda80"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const listaDiv = document.getElementById("listaPendentes");

onAuthStateChanged(auth, async (user) => {
    if (!user) {
        window.location.href = "login.html";
        return;
    }
    const userRef = doc(db, "usuarios", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists() || userSnap.data().admin !== true) {
        alert("Acesso negado. Admin only.");
        window.location.href = "dashboard.html";
        return;
    }
    iniciarListener();
});

function iniciarListener() {
    const q = query(collection(db, "acoes_pendentes"), where("status", "==", "pendente"));

    onSnapshot(q, (snapshot) => {
        listaDiv.innerHTML = "";
        if (snapshot.empty) {
            listaDiv.innerHTML = `<div class="empty-state" style="grid-column: 1/-1;">üéâ Tudo limpo! Nenhuma a√ß√£o pendente.</div>`;
            return;
        }

        snapshot.forEach((d) => {
            const data = d.data();
            const id = d.id;
            
            // Aceita comprovanteBase64 (seu padr√£o antigo) ou comprovante (novo)
            const imgSrc = data.comprovanteBase64 || data.comprovante || '';
            const nomeUser = data.nome || data.email || "Usu√°rio";

            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
                <div>
                    <div class="user-info">üë§ ${nomeUser} <br> <small>${data.curso || ''}</small></div>
                    <h3 class="acao-title">${data.acao}</h3>
                    <span class="pontos-badge">+${data.pontos} Pontos</span>
                    ${imgSrc ? 
                        `<img src="${imgSrc}" class="comprovante-img" onclick="window.open(this.src)" title="Clique para ampliar">` : 
                        `<p style="color:red; text-align:center;">‚ö†Ô∏è Sem imagem</p>`
                    }
                </div>
                <div class="actions">
                    <button class="btn-rejeitar" onclick="rejeitar('${id}')">Rejeitar</button>
                    <button class="btn-aprovar" onclick="aprovar('${id}', '${data.uid}', ${data.pontos})">Aprovar</button>
                </div>
            `;
            listaDiv.appendChild(card);
        });
    });
}

window.aprovar = async (docId, userId, pontos) => {
    if(!confirm("Aprovar e dar pontos?")) return;
    try {
        await updateDoc(doc(db, "acoes_pendentes", docId), { status: "aprovada" });
        await updateDoc(doc(db, "usuarios", userId), { pontos: increment(pontos) });
    } catch (error) {
        alert("Erro: " + error.message);
    }
};

window.rejeitar = async (docId) => {
    const motivo = prompt("Motivo da rejei√ß√£o:");
    if (motivo === null) return;
    try {
        await updateDoc(doc(db, "acoes_pendentes", docId), { status: "rejeitada", motivoRejeicao: motivo });
    } catch (error) {
        alert("Erro: " + error.message);
    }
};

window.logout = async () => {
    await signOut(auth);
    window.location.href = "login.html";
};
</script>
</body>
</html>




